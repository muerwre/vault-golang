kind: pipeline
name: build
type: docker

platform:
  os: linux
  arch: amd64

steps:
  - name: compress
    image: golang:1.15
    commands:
      - rm -rf ./app.tar
      - tar -cvf ./app.tar -C ./ .
  - name: upload-develop
    image: drillster/drone-rsync
    when:
      branch: develop
    environment:
      RSYNC_KEY:
        from_secret: rsync_key
      RSYNC_USER:
        from_secret: rsync_user
      RSYNC_PATH:
        from_secret: rsync_path_develop
      PLUGIN_ARGS: -zz -O --no-perms
    settings:
      port: 22522
      hosts:
        - vault48.org
      source: ./
      user: ${rsync_user}
      key: ${rsync_key}
      target: $${RSYNC_PATH}
      include:
        - "app.tar"
      exclude:
        - "*"
      script:
#        - cd /opt/deploys/drone/vault/staging/backend
#        - docker-compose build
#        - docker-compose up -d
        - echo $${RSYNC_PATH}
        - tar -xf ./app.tar -C ./
  - name: build
    image: appleboy/drone-ssh
    environment:
      RSYNC_PATH:
        from_secret: rsync_path_develop
    settings:
      host: vault48.org
      username: derek
      key:
        from_secret: rsync_key
      envs: [rsync_user]
      port: 22522
      script:
        - cd $${RSYNC_USER}
        - ls ./
